<!DOCTYPE html>
<html lang="en">
<head>
    <title>Fleet Management</title>

    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Descrptions needs to be added here" />
    <meta name="keywords" content="Microsoft maps, map, gis, API, SDK, animate, animation, symbols, pushpins, markers, pins, line, linestring, polyline" />
    <meta name="author" content="Microsoft Azure Maps" />

    <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" type="text/css" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
	
	 <!-- Add a reference to the HtmlMarkerLayer script. -->
    <script src="HtmlMarkerLayer.js"></script>

    <script type='text/javascript'>
	
        var map, pin, datasource,marker,popup;
        var animationTime = 6000;
        var animation;
				
        //Create an array of points to define a path to animate along.
        var path = [
           [-122.18822, 47.63208],
           [-122.18204, 47.63196],
           [-122.17243, 47.62976],
           [-122.16419, 47.63023],
		   [-122.15852, 47.62942],
		   [-122.15183, 47.62988],
		   [-122.14256, 47.63451],
		   [-122.13483, 47.64041],
		   [-122.13466, 47.64422],
		   [-122.13844, 47.65440],
		   [-122.13277, 47.66515],
		   [-122.12779, 47.66712],
		   [-122.11595, 47.66712],
		   [-122.11063, 47.66735],
		   [-122.10668, 47.67035],
		   [-122.10565, 47.67498]

        ];

        //Data points for a path, could be from a GPS device.
        var points = [
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.18822, 47.63208] }, properties: { speed: 55 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.18204, 47.63196] }, properties: { speed: 57 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.17243, 47.62976] }, properties: { speed: 58 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.16419, 47.63023] }, properties: { speed: 60 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.15852, 47.62942] }, properties: { speed: 62 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.15183, 47.62988] }, properties: { speed: 63 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.14256, 47.63451] }, properties: { speed: 61 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.13483, 47.64041] }, properties: { speed: 65 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.13466, 47.64422] }, properties: { speed: 67 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.13844, 47.65440] }, properties: { speed: 68 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.13277, 47.66515] }, properties: { speed: 70 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.12779, 47.66712] }, properties: { speed: 73 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.11595, 47.66712] }, properties: { speed: 75 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.11063, 47.66735] }, properties: { speed: 68 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.10668, 47.67035] }, properties: { speed: 64 } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [-122.10565, 47.67498] }, properties: { speed: 60 } }
        ];
		
        function GetMap() {
            //Initialize a map instance.
            map = new atlas.Map('myMap', {
                center: [-122.135, 47.65],
                zoom: 12,
				style: 'road',
                view: 'Auto',
               //Set the language of the map.
                language: 'en-US',
				
				//Add your Azure Maps subscription key to the map SDK. Get an Azure Maps key at https://azure.com/maps
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: 'x4OKrH-wlKiAZgo6GMH8NECEN7hlZgorUcgkPy1xQaU'
                }
            });
			
            //Wait until the map resources are ready.
            map.events.add('ready', function () {

                //Create a data source and add it to the map.
                datasource = new atlas.source.DataSource(null, {
                    cluster: true
                });
                map.sources.add(datasource);

                //Add sample data.
				datasource.add([
                    new atlas.data.Feature(new atlas.data.Point([-122.17243, 47.62976]), {
                        title: 'Check Point info',
						Vehicle_Number: 'KA01 ME5612',
						Route : 'A1 to B1',
						Continous_driving_hours : '02:10:10',
                        Average_speed: '55 mph',
						Lane_violation: '0',
						HA : '0',
						HB : '0',
						Risk_index:'low',
						live_feed: '<iframe style="margin:10px" width="400" height="200" src="https://channel9.msdn.com/Shows/Internet-of-Things-Show/Azure-Maps-intro-for-developers/player" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>',                    
                        popupTemplate: {
                            detectHyperlinks: true
                        },
						assigned: false
                    }),

                    new atlas.data.Feature(new atlas.data.Point([-122.14256, 47.63451]), {
                        title: 'Check Point info',
						Vehicle_Number: 'KA01 ME5612',
						Route : 'B1 to C1',
						Continous_driving_hours : '04:20:30',
                        Average_speed: '68 mph',
						Overspeeding: '0',
						Lane_violation: '0',
						HA : '1',
						HB : '2',
						Risk_index:'medium',
						assigned: false
                    }),

                    new atlas.data.Feature(new atlas.data.Point([-122.12779, 47.66712]), {
                        title: 'Check Point info',
						Vehicle_Number: 'KA01 ME5612',
						Route : 'A1 to D1',
						Continous_driving_hours : '08:34:10',
                        Average_speed: '74 mph',
						Overspeeding: '6',
						Lane_vialation: '2',
						HA : '3',
						HB : '4',
						Risk_index:'High',
                        COP: 'https://azuremapscodesamples.azurewebsites.net/common/images/Pike_Market.jpg',
						assigned: true
                    }),
                ]);

                //Add a layer for rendering point data as symbols.
				var layer = new atlas.layer.SymbolLayer(datasource, null, {
							iconOptions: {
						image: [
							'case',
							['get', 'assigned'], 'pin-red',
							'pin-darkblue'
						]
					}
						  });
                map.layers.add(layer);
				
                //Create a popup but leave it closed so we can update it and display it later.
				popup = new atlas.Popup();

                //Add a click event to the symbol layer.
                map.events.add('click', layer, showPopup);



			/* Construct and add a compass control*/
			  var compassControl = new atlas.control.CompassControl();
			  map.controls.add(compassControl, {
				position: "bottom-right"
			  });

			  /* Construct and add a zoom control*/
			  var zoomControl = new atlas.control.ZoomControl();
			  map.controls.add(zoomControl, {
				position: "bottom-right"
			  });

			  /* Construct and add a pitch control*/
			  var pitchControl = new atlas.control.PitchControl();
			  map.controls.add(pitchControl, {
				position: "bottom-right"
			  });

			  /* Construct and add a style control*/
			  var styleControl = new atlas.control.StyleControl();
			  map.controls.add(styleControl, {
			  position: "bottom-right"
			  })
			

                //Load a custom image icon into the map resources.
                map.imageSprite.add('arrow-icon', './Common/images/icons/truck.png').then(function () {
				 
				 //Create a data source and add it to the map. 
                datasource = new atlas.source.DataSource(null, {
                    lineMetrics: true   //Enable line metrics on the data source. This is needed to enable support for strokeGradient.
                });
				 
                 map.sources.add(datasource);	
				 //datasource.add(points);
                //Create a line from the points and add it to the data source.
                var line = createLineFrom(points);
                datasource.add(line);
				
				//Calculate a color gradient expression based on the speed of each data point.
                var speedGradient = calculateGradientExpression(points, line);

                //Create a line layer and pass in a gradient expression for the strokeGradient property.
                map.layers.add(new atlas.layer.LineLayer(datasource, null, {
                    strokeWidth: 4,
                    strokeGradient: speedGradient
                }));

                //Create a layer to render each data point along the path.
                var pointLayer = new atlas.layer.SymbolLayer(datasource, null, {
                    //Only render point data in this layer, not the points of the line.
                     filter: ['==', ['geometry-type'], 'Point'],
						iconOptions: {
						image: [
							'case',
							['get', 'assigned'], 'pin-red',
							'pin-darkblueblue'
						]
					}
                });
	

                //Open/close the popup when hovered.
                map.events.add('mousemove', pointLayer, pointClicked);
                map.events.add('mouseout', pointLayer, closePopup);

                map.layers.add(pointLayer);
				   
                 //Create a layer to render a symbol which we will animate.
                    map.layers.add(new atlas.layer.SymbolLayer(datasource, null, {
                        iconOptions: {
                            //Pass in the id of the custom icon that was loaded into the map resources.
                            image: 'arrow-icon',
                            //Anchor the icon to the center of the image.
                            anchor: 'center',
                            //Rotate the icon based on the rotation property on the point data.
                            rotation: ['get', 'rotation'],
                            //Have the rotation align with the map.
                            rotationAlignment: 'map',
                            //For smoother animation, ignore the placement of the icon. This skips the label collision calculations and allows the icon to overlap map labels. 
                            ignorePlacement: true,
                            //For smoother animation, allow symbol to overlap all other symbols on the map.
                            allowOverlap: true    
                        },
                        textOptions: {
                            //For smoother animation, ignore the placement of the text. This skips the label collision calculations and allows the text to overlap map labels.
                            ignorePlacement: true,
                            //For smoother animation, allow text to overlap all other symbols on the map.
                            allowOverlap: true  
                        },
                        //Only render Point or MultiPoints in this layer.    
                        filter: ['any', ['==', ['geometry-type'], 'Point'], ['==', ['geometry-type'], 'MultiPoint']] 
                    }));
                    //Create a pin and wrap with the shape class and add to data source.
                    pin = new atlas.Shape(new atlas.data.Feature(new atlas.data.Point(path[0]), {
                        rotation: 180
                    }));
                    datasource.add(pin);
                    animation = new animations.PathAnimation(path, function (position, heading, progress) {
                        //Update the rotation of the symbol. 
                        pin.setProperties({
                            rotation: heading
                        });
                        //Update the symbols coordinates.
                        pin.setCoordinates(position);
                        if (document.getElementById('followSymbol').checked) {
                            map.setCamera({
                                center: position,
                                bearing: heading,
                                pitch: 45,
                                zoom: 15
                            });
                        }
                    }, animationTime);
                });
				
			   	
				var marker = new atlas.HtmlMarker({
				color: 'DodgerBlue',
				text: 'TT-1',
				position: [-122.18822, 47.63208],
				popup: new atlas.Popup({
				content: '<div style="padding:10px"><font color="white">Driver Name : BUNJONG BORIBOON ,<br>TT Number : KA 01 EU0073, <br>Fleet_Risk_Assesment :</font><font color="yellow"> Medium</font> </div>',
				pixelOffset: [0, -30],
				fillColor: 'rgba(0,0,0,0.4)',
				draggable: true

					})
				});

				map.markers.add(marker);

				//Add a click event to toggle the popup.
				map.events.add('click',marker, () => {
					marker.togglePopup();
				});
				
            });
        }
		
         function showPopup(e) {
            if (e.shapes && e.shapes.length > 0) {
                var properties = e.shapes[0].getProperties();

                popup.setOptions({
                    //Update the content of the popup.
                    content: atlas.PopupTemplate.applyTemplate(properties, properties.popupTemplate),

                    //Update the position of the popup with the pins coordinate.
                    position: e.shapes[0].getCoordinates()
                });

                //Open the popup.
                popup.open(map);
            }
        }

        function updateLanguage() {
            var langOptions = document.getElementById('langOptions');
            var lang = langOptions.options[langOptions.selectedIndex].value;
            //Update the language of the map instance.
            map.setStyle({
                language: lang
            });
        }
		
		
		function createLineFrom(points) {
            var coords = [];
            for (var i = 0; i < points.length; i++) {
                coords.push(points[i].geometry.coordinates);
            }
            return new atlas.data.LineString(coords);
        }

        function calculateGradientExpression(points, line) {
            var exp = [
                'interpolate',  //This will cause the colors from each data point to create a gradient between points.
                ['linear'],
                ['line-progress']
            ];

            //Get the total length of the path.
            var totalLength = atlas.math.getLengthOfPath(line);

            //The line progress will be a fraction of the total length of the path,
            //so we can calculate the line progress value of each data point and set the color accordingly.
            var progress = 0;

            for (var i = 0; i < points.length; i++) {
                //The line progress value is a value between 0 and 1. 
                //Taking the travelled distance and dividing it by the total distance of the path, will give us the line progress value.
                exp.push(progress / totalLength);

                //Add our business logic on how a data point should be colored based on the speed.

                if (points[i].properties.speed <= 60) {
                    exp.push('green');
                } else if (points[i].properties.speed < 70) {
                    exp.push('yellow');
                } else {
                    exp.push('red');
                }

                if (i < points.length - 1) {
                    progress += atlas.math.getDistanceTo(points[i], points[i + 1]);
                }
            }

            return exp;
        }

        function pointClicked(e) {
            var prop = e.shapes[0].getProperties();

            popup.setOptions({
                content: '<div style="padding:10px;">Speed: '+ '0 mph </div>',
                position: e.shapes[0].getCoordinates()
            });

            popup.open(map);
        }

        function closePopup() {
            popup.close();
        }
    	
		
        function play() {
            if (animation) {
                animation.play();
            }
        }
        function pause() {
            if (animation) {
                animation.pause();
            }
        }
        function stop() {
            if (animation) {
                animation.stop();
            }
        }
        var animations = (function () {
            var self = this;
            var _delay = 30; //30 = 33.3 frames per second, 16 = 62.5 frames per second
            this.PathAnimation = function (path, intervalCallback, duration) {
                /// <summary>This class extends from the BaseAnimation class and cycles through a set of positions over a period of time, calculating mid-point positions along the way.</summary>
                /// <param name="path" type="Position[]">An array of positions to cycle through.</param>
                /// <param name="intervalCallback" type="Function">A function that is called when a frame is to be rendered. This callback function recieves three values; current position, heading, progress.</param>
                /// <param name="duration" type="Number">Length of time in ms that the animation should run for. Default is 1000 ms.</param>
                var _totalDistance = 0,
                    _intervalLocs = [path[0]],
                    _intervalHeadings = [],
                    _intervalIdx = [0],
                    _frameCount = Math.ceil(duration / _delay), idx;
                var progress, dlat, dlon;
                //Calcualte the total distance along the path in degrees.
                for (var i = 0; i < path.length - 1; i++) {
                    dlat = (path[i + 1][1] - path[i][1]);
                    dlon = (path[i + 1][0] - path[i][0]);
                    _totalDistance += Math.sqrt(dlat * dlat + dlon * dlon);
                }
                //Pre-calculate step points for smoother rendering.
                for (var f = 0; f < _frameCount; f++) {
                    progress = (f * _delay) / duration;
                    var travel = progress * _totalDistance;
                    var alpha;
                    var dist = 0;
                    var dx = travel;
                    for (var i = 0; i < path.length - 1; i++) {
                        dlat = (path[i + 1][1] - path[i][1]);
                        dlon = (path[i + 1][0] - path[i][0]);
                        alpha = Math.atan2(dlat * Math.PI / 180, dlon * Math.PI / 180);
                        dist += Math.sqrt(dlat * dlat + dlon * dlon);
                        if (dist >= travel) {
                            idx = i;
                            break;
                        }
                        dx = travel - dist;
                    }
                    if (dx != 0 && idx < path.length - 1) {
                        dlat = dx * Math.sin(alpha);
                        dlon = dx * Math.cos(alpha);
                        var dest = [path[idx][0] + dlon, path[idx][1] + dlat];
                        _intervalLocs.push(dest);
                        _intervalHeadings.push(atlas.math.getHeading(path[idx], dest));
                        _intervalIdx.push(idx);
                    }
                }
                //Ensure the last location is the last position in the path.
                _intervalHeadings.push(atlas.math.getHeading(_intervalLocs[_intervalLocs.length - 1], path[path.length - 1]));
                _intervalLocs.push(path[path.length - 1]);
                _intervalIdx.push(path.length - 1);
                if (_intervalHeadings.length < _intervalLocs.length) {
                    _intervalHeadings.push(_intervalHeadings[_intervalHeadings.length - 1]);
                }
                return new self.BaseAnimation(
                    function (progress, frameIdx) {
                        if (intervalCallback) {
                            intervalCallback(_intervalLocs[frameIdx], _intervalHeadings[frameIdx], progress);
                        }
                    }, duration);
            }
            this.BaseAnimation = function (renderFrameCallback, duration) {
                /// <summary>A base class that can be used to create animations that support play, pause and stop.</summary>
                /// <param name="renderFrameCallback" type="Function">A function that is called when a frame is to be rendered. This function recieves two values; progress and frameIdx.</param>
                /// <param name="duration" type="Number">Length of time in ms that the animation should run for. Default is 1000 ms.</param>
                var _timerId,
                    frameIdx = 0,
                    _isPaused = true;
                //Varify value
                duration = (duration && duration > 0) ? duration : 1000;
                this.play = function () {
                    if (renderFrameCallback) {
                        _isPaused = false;
                        if (!_timerId) {
                            _timerId = setInterval(function () {
                                if (!_isPaused) {
                                    var progress = (frameIdx * _delay) / duration;
                                    renderFrameCallback(progress, frameIdx);
                                    if (progress >= 1) {
                                        //reset();
                                    }
                                    frameIdx++;
                                }
                            }, _delay);
                        }
                    }
                };
                this.isPlaying = function () {
                    return !_isPaused;
                };
                this.pause = function () {
                    _isPaused = true;
                };
                this.stop = function () {
                    reset();
                };
                function reset() {
                    if (_timerId != null) {
                        clearInterval(_timerId);
                        _timerId = null;
                    }
                    frameIdx = 0;
                    renderFrameCallback(0, frameIdx);
                    _isPaused = true;
                }
            }
            return self;
        })();
    </script>

    <style>
        #myMap {
            position: relative;
            width: 100%;
            min-width:290px;
            height: 500px;
        }
        .controlPanel {
            position:absolute;
            top:15px;
            left:15px;
            border-radius:5px;
            padding:5px;
            background-color:white;
        }
    </style>
	
</head>

	<body onload="GetMap()">
		<div id="myMap"></div>
		<div class="controlPanel">

	   <select>
		<option selected="selected">TT-1</option>
		<option value="TT-2">TT-2</option>
		<option value="TT-3">TT-3</option>
	   </select> 
			<input type="button" value="Track TT" onclick="play()" />
			<input type="button" value="Pause" onclick="pause()" />
			<input type="button" value="Stop" onclick="stop()" />
			<br/>
			Follow: <input id="followSymbol" type="checkbox"/>
		</div>

		<fieldset style="width:calc(100% - 40px);min-width:290px;margin-top:2px;">
			<legend><h1 style="font-size:15px">Driver Risk Index </h1></legend>
			

<table style="width: 1100px; height: 79px; float: left;" border="0.5" cellspacing="0" cellpadding="0"><caption>&nbsp;</caption>
<tbody>
<tr style="height: 41px;">
<td style="width: 85px; height: 41px; text-align: left;"><span style="color: #000080;"><strong>DriverName</strong></span></td>
<td style="width: 76px; height: 41px; text-align: left;"><span style="color: #000080;"><strong>Vehicle No</strong></span></td>
<td style="width: 68px; height: 41px; text-align: left;"><span style="color: #000080;"><strong>Route</strong></span></td>
<td style="width: 93px; height: 41px; text-align: left;"><span style="color: #000080;"><strong>Risk Rating</strong></span></td>
<td style="width: 155px; height: 41px; text-align: left;"><span style="color: #000080;"><strong>Continuous Driveing hours (HH:MM)</strong></span></td>
<td style="width: 95px; height: 41px; text-align: left;"><span style="color: #000080;"><strong>Overs speeding</strong></span></td>
<td style="width: 98px; height: 41px; text-align: left;"><span style="color: #000080;"><strong>Lane violation</strong></span></td>
<td style="width: 28px; height: 41px; text-align: left;"><span style="color: #000080;"><strong>HA</strong></span></td>
<td style="width: 51.33px; height: 41px; text-align: left;"><span style="color: #000080;"><strong>HB</strong></span></td>
<td style="width: 45.67px; height: 41px; text-align: left;"><span style="color: #000080;"><strong>HC</strong></span></td>
<td style="width: 77px; height: 41px; text-align: left;"><span style="color: #000080;"><strong>Distraction</strong></span></td>
<td style="width: 80px; height: 41px; text-align: left;"><span style="color: #000080;"><strong>yawning</strong></span></td>
</tr>
<tr style="height: 21.5px;">
<td style="width: 85px; height: 21.5px; text-align: center;">Vijay&nbsp;</td>
<td style="width: 76px; height: 21.5px; text-align: center;">Gj01FV1070</td>
<td style="width: 68px; height: 21.5px; text-align: center;">A to B</td>
<td style="width: 93px; height: 21.5px; text-align: center;">8.5</td>
<td style="width: 155px; height: 21.5px; text-align: center;">02:50</td>
<td style="width: 95px; height: 21.5px; text-align: center;">2</td>
<td style="width: 98px; height: 21.5px; text-align: center;">0</td>
<td style="width: 28px; height: 21.5px; text-align: center;">3</td>
<td style="width: 51.33px; height: 21.5px; text-align: center;">7</td>
<td style="width: 45.67px; height: 21.5px; text-align: center;">0</td>
<td style="width: 77px; height: 21.5px; text-align: center;">1</td>
<td style="width: 80px; height: 21.5px; text-align: center;">2</td>
</tr>
<tr style="height: 21px;">
<td style="width: 85px; height: 21px; text-align: center;">Gurvinder</td>
<td style="width: 76px; height: 21px; text-align: center;">GJ05KP2603</td>
<td style="width: 68px; height: 21px; text-align: center;">B to C</td>
<td style="width: 93px; height: 21px; text-align: center;">4.7</td>
<td style="width: 155px; height: 21px; text-align: center;">03:12</td>
<td style="width: 95px; height: 21px; text-align: center;">1</td>
<td style="width: 98px; height: 21px; text-align: center;">0</td>
<td style="width: 28px; height: 21px; text-align: center;">0</td>
<td style="width: 51.33px; height: 21px; text-align: center;">2</td>
<td style="width: 45.67px; height: 21px; text-align: center;">0</td>
<td style="width: 77px; height: 21px; text-align: center;">0</td>
<td style="width: 80px; height: 21px; text-align: center;">0</td>
</tr>
</tbody>
</table>

<p style="text-align: justify;"><span style="color: #000080;"><strong>&nbsp; &nbsp; &nbsp; Critical </strong></span><span style="color: #000080;"><strong>Alarm detials</strong></span></p>
<p style="text-align: justify;">&nbsp; &nbsp; &nbsp;&nbsp; Risky Driving&nbsp;Event &nbsp; &nbsp; &nbsp;&nbsp; : Harsh Breaking on DD/MM/YYYY at HH:MM:SS <br />&nbsp; &nbsp; &nbsp;&nbsp; Vehicle Speed &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : 60 kmph <br />&nbsp; &nbsp; &nbsp;&nbsp; Continous Driving Hours&nbsp; : 2 Hours 42 min <br />&nbsp; &nbsp; &nbsp;&nbsp; Distraction : &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :Yes , <a title="alarm details" href="&lt;table style=&quot;width: 500px; height: 79px; float: left;&quot; border=&quot;0.5&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot;&gt;&lt;caption&gt;&lt;video poster=&quot;Play Video&quot; controls=&quot;controls">Play Video</a></p>
<p>&nbsp;</p>



			
		</fieldset>
	</body>

</html>
